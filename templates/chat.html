<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THUG-CHAT</title>
   <style>
body {
    background-color: #36393e;
    color: #e0e0e0;
    font-family: Arial, sans-serif;
    margin: 0;
    overflow: hidden;
    display: flex;
    height: 100vh;
    flex-direction: row;
    flex-wrap: wrap; /* Allow wrapping of children if necessary */
}

.open-commands-button {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 50px;
    padding: 0 20px;
    background-color: #42464d;
    color: #ffffff;
    border: none;
    border-radius: 0;
    cursor: pointer;
    position: absolute;
    top: 5px;
    right: 15px;
    z-index: 1000;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
    font-size: 14px;
    max-width: 120px;
}

.open-commands-button:hover {
    background-color: #4f545c;
    transform: scale(1.05);
}

.userbutton {
    background-color: #2f3136;
    color: #dcddde;
    border: 1px solid #3f4146;
    padding: 12px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    text-align: left;
    margin: 2.5% 0; /* Using percentage to adjust spacing based on screen size */
    box-shadow: none;
    transition: background-color 0.3s;
}

.userbutton:hover {
    background-color: #4f545c;
}

.userbutton:active {
    background-color: #42464d;
}

/* Media queries for responsiveness */
@media (max-width: 768px) {
    .userbutton {
        margin: 5% 0; /* Increase margin on smaller screens */
    }
}

@media (max-width: 480px) {
    .userbutton {
        margin: 10% 0; /* Further increase margin on very small screens */
    }
}


#sidebar {
    width: 200px; /* Default width for the sidebar */
    background-color: #2c2f33; /* Sidebar background */
    padding: 10px;
    overflow-y: auto;
    height: 100%;
    border-right: 1px solid #40444b; /* Border for separation */
    transition: width 0.3s, left 0.3s; /* Smooth transition for width and position */
}

#sidebar::-webkit-scrollbar {
    width: 10px; /* Scrollbar width */
}

#sidebar::-webkit-scrollbar-thumb {
    background-color: #444; /* Scrollbar thumb color */
    border-radius: 5px;
}

#sidebar::-webkit-scrollbar-thumb:hover {
    background-color: #666; /* Darker on hover */
}

#sidebar::-webkit-scrollbar-track {
    background: #2c2f33; /* Scrollbar track color */
    border-radius: 5px;
}

/* Media queries for responsiveness */
@media (max-width: 768px) {
    #sidebar {
        width: 150px; /* Reduced width on smaller screens */
    }
}

@media (max-width: 480px) {
    #sidebar {
        width: 100px; /* Further reduced width on very small screens */
        position: absolute; /* Positioning to prevent overlap */
        left: -100px; /* Hide off-screen */
        transition: left 0.3s; /* Smooth transition for opening */
    }

    #sidebar.open {
        left: 0; /* Position it back when open */
    }
}

/* Media query for aspect ratio 16:9 or less */
@media (max-aspect-ratio: 14/10) {
    #sidebar {
        display: none; /* Hide sidebar */
    }

    #chat-container {
        margin-left: 0; /* Remove margin to utilize full width */
        flex: 1; /* Allow chat container to take the full space */
    }
}

#chat-container {
    display: flex;
    flex-direction: column;
    flex: 1; /* Allow chat container to fill available space */
    margin-left: 50px; /* Adjust as necessary for larger screens */
    transition: margin-left 0.3s; /* Smooth transition for margin */
    padding-top: 0; /* No padding needed when sidebar is hidden */
}




#chat-box::-webkit-scrollbar {
    width: 16px; /* Scrollbar width */
}

#chat-box::-webkit-scrollbar-track {
    background: #2C2F33; /* Track color */
    border-radius: 0; 
}

#chat-box::-webkit-scrollbar-thumb {
    background-color: #333333; /* Thumb color */
    border-radius: 0; 
    border: 4px solid transparent; 
}

#chat-box::-webkit-scrollbar-thumb:hover {
    background-color: #5b6eae; /* Thumb hover color */
}

.textarea-container {
    position: relative;
    padding-left: 50px; /* Space for icons or buttons */
}

#chat-container {
    display: flex;
    flex-direction: column;
    flex: 1; /* Allow chat container to fill available space */
    margin-left: 50px; /* Adjust as necessary for larger screens */
    transition: margin-left 0.3s; /* Smooth transition for margin */
    height: 100%; /* Ensure the container takes full height */
}

#chat-box {
    flex: 1; /* Allow chat box to take up remaining space */
    overflow-y: auto; 
    padding: 10px;
    padding-left: 15px;
    border-bottom: 1px solid #333;
    word-wrap: break-word;
    white-space: pre-wrap;
}

#message-form {
    display: flex;
    background-color: #2f3136; /* Darker background for the message form */
    padding: 10px;
    border-top: 1px solid #40444b; /* Lighter border for visibility */
    flex-wrap: wrap;
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3); /* Optional shadow for separation */
    margin-top: auto; /* Push the message form to the bottom */
}

#message-input {
    flex: 1;
    padding: 10px;
    border: 1px solid #555; /* Darker border */
    background-color: #40444b; /* Dark input background */
    color: #dcddde; /* Lighter text color */
    min-width: 0;
    resize: none;
    line-height: 1.5em;
    white-space: pre-wrap;
    overflow-wrap: break-word;
    box-sizing: border-box;
    font-family: inherit;
    word-break: break-word;
    padding-bottom: 10px; /* Adjust padding to avoid unnecessary space */
}

/* Media queries for responsiveness */
@media (max-aspect-ratio: 9/16) {
    #chat-container {
        height: 100vh; /* Full viewport height for smaller screens */
    }

    #chat-box {
        padding-bottom: 0; /* Remove bottom padding for chat box */
    }

    #message-form {
        margin-top: auto; /* Ensures it stays at the bottom */
    }
}

@media (max-width: 768px) {
    #sidebar {
        width: 150px; /* Reduced width on smaller screens */
    }
}

@media (max-width: 480px) {
    #sidebar {
        width: 100px; /* Further reduced width on very small screens */
        position: absolute; /* Positioning to prevent overlap */
        left: -100px; /* Hide off-screen */
        transition: left 0.3s; /* Smooth transition for opening */
    }

    #sidebar.open {
        left: 0; /* Position it back when open */
    }
}

/* Media queries for responsiveness */
@media (max-width: 480px) {
    #chat-container {
        flex-direction: column; /* Ensure the chat container stacks vertically */
    }

    #message-form {
        padding: 5px; /* Reduced padding for smaller screens */
    }

    #message-input {
        padding: 8px; /* Reduced input padding for smaller screens */
    }
}


#char-count {
    position: absolute;
    left: -40px; /* Move to the left side */
    bottom: 50px; /* Adjust this value to set its height */
    color: #aaa; /* Lighter gray for visibility */
    font-size: 0.8em;
    pointer-events: none; 
}

/* Media queries for responsiveness */
@media (max-width: 768px) {
    #chat-container {
        margin-left: 20px; /* Reduce left margin on smaller screens */
    }

    #message-form {
        flex-direction: column; /* Stack elements vertically */
    }

    #message-input {
        margin-bottom: 10px; /* Space between input and any other buttons */
        padding-bottom: 15px; /* Adjust padding for better spacing */
    }

    #char-count {
        left: -30px; /* Adjust position for better visibility */
        bottom: 40px; /* Adjust bottom position */
    }
}

@media (max-width: 480px) {
    #chat-container {
        margin-left: 10px; /* Further reduce left margin */
    }

    #message-form {
        padding: 5px; /* Reduce padding for smaller screens */
    }

    #message-input {
        padding: 8px; /* Adjust padding for smaller screens */
        min-height: 40px; /* Set a minimum height for usability */
    }

    #char-count {
        left: -20px; /* Further adjust position */
        bottom: 30px; /* Further adjust bottom position */
        font-size: 0.7em; /* Smaller font size */
    }
}



button {
    margin-top: 10px; 
}

.message {
    display: flex; /* Use flexbox for alignment */
    align-items: center; /* Center items vertically */
    margin-bottom: 10px; /* Space between messages */
}

.profile-picture {
    width: 40px; 
    height: 40px;
    border-radius: 50%; 
    object-fit: cover; 
    margin-right: 5px; /* Space between the picture and username */
}



.container {
    display: flex; /* Use flexbox to align buttons horizontally */
    align-items: flex-end; /* Align buttons to the bottom of the container */
    height: 100%; /* Ensure the container takes the full height */
}

#send-button, #upload-button {
    display: flex; 
    align-items: center; 
    justify-content: center; 
    height: 50px; /* Reduced height for better fit on mobile */
    padding: 0 20px; 
    border: none;
    color: #ffffff; 
    cursor: pointer;
    margin-left: 10px; 
    flex-shrink: 0; 
    transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    border-radius: 0; 
    font-size: 14px; 
    max-width: 120px; /* Limit the maximum width of buttons */
}

#send-button, #upload-button {
    background-color: #4a90e2; 
}

#send-button:hover, #upload-button:hover {
    background-color: #3a80c3; 
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
}

#send-button:active, #upload-button:active {
    background-color: #2f65a0; 
    transform: translateY(2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

#logout-button {
    display: flex; 
    align-items: center; 
    justify-content: center; 
    height: 50px; /* Reduced height for better fit on mobile */
    padding: 0 20px; 
    border: none;
    background-color: #d9534f; 
    color: #ffffff; 
    cursor: pointer;
    margin-left: 10px; 
    margin-top: 10px; 
    flex-shrink: 0; 
    transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    border-radius: 0; 
    font-size: 14px; 
    text-decoration: none; 
    font-weight: bold; 
    text-transform: uppercase; 
    max-width: 120px; /* Limit the maximum width of the logout button */
}

#logout-button:hover {
    background-color: #c9302c; 
}

#logout-button:active {
    background-color: #a52c2c; 
    transform: translateY(2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

@media (max-width: 768px) {
    #send-button, #upload-button, #logout-button {
        flex: 1; /* Allow buttons to grow in width if necessary */
        min-width: 100px; /* Set a minimum width for buttons */
    }
    
    #message-form {
        flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
    }
}




.link {
    color: lightblue;
    font-weight: bold;
    white-space: nowrap;
    text-decoration: none;
}

.link:hover {
    text-decoration: underline;
}

.message {
    margin-bottom: 2px;
    padding: 2px 0;
    word-wrap: break-word;
    white-space: pre-wrap;
}

.typing-indicator {
    color: #999;
    font-style: italic;
}

.progress {
    width: 100%;
    background-color: #333;
}

.progress-bar {
    width: 0;
    height: 5px;
    background-color: #ec0a0a;
}

.download-button {
    display: inline-block;
    padding: 8px 16px;
    margin: 8px 0;
    color: #e0e0e0;
    background-color: #444;
    border: none;
    cursor: pointer;
    text-decoration: none;
}

.download-button:hover {
    background-color: #555;
}

#sidebar ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

#sidebar li {
    padding: 5px 0;
    color: #e0e0e0;
    cursor: pointer;
}

#sidebar li:hover {
    background-color: #333;
}


#warning-message {
    color: #8e16f7;
    text-align: center;
    margin: 10px;
    display: none;
}

.timestamp {
    font-size: 10px;
    color: #999;
    float: right;
    margin-left: 10px;
}

#button-container {
    position: relative; /* Position context for absolute children */
}

#reload-button {
    position: absolute; 
    background-color: #42464d; 
    border: none; 
    width: 120px; 
    height: 50px; 
    color: #ffffff; 
    cursor: pointer; 
    z-index: 1000; 
    transition: background-color 0.3s, transform 0.2s; 
    font-size: 14px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    top: 5px; 
    right: calc(5% + 290px); /* Move left slightly using calc */
    text-transform: uppercase; 
    font-weight: bold; 
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); 
    border-radius: 0; 
}

#reload-button:hover {
    background-color: #4f545c; 
    transform: scale(1.05); 
}

#reload-button:active {
    background-color: #3a3a3a; 
    transform: scale(0.98); 
}


#adminButton {
    position: absolute; /* Use absolute positioning */
    background-color: #42464d; /* Dark button background */
    color: #ffffff; /* Button text color */
    border: none;
    width: 150px; /* Set width */
    height: 50px; /* Set height */
    cursor: pointer;
    z-index: 1000;
    padding: 10px 15px; /* Adjusted padding for visual balance */
    border-radius: 4px; /* Subtle rounded corners */
    display: flex;
    align-items: center;
    justify-content: center;
    top: 5px; /* Set y-coordinate */
    right: calc(5% + 130px); /* Adjusted right position based on button width */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); /* Updated box shadow */
    transition: background-color 0.3s, transform 0.2s; /* Smooth transitions */
}

#adminButton:hover {
    background-color: #51565e; /* Slightly lighter background on hover */
    transform: scale(1.05); /* Scale effect on hover */
}

#adminButton:active {
    background-color: #3a3a3a; /* Darker background on active */
    transform: scale(0.98); /* Slight scale effect on active */
}


@media (max-width: 768px) {
    body {
        flex-direction: column;
        height: auto; 
        overflow: auto; 
    }

    #sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #333333;
        padding: 5px;
    }

    #chat-container {
        margin-left: 0;
        margin-top: 10px;
        flex: 1;
        height: calc(100vh - 150px); 
        display: flex;
        flex-direction: column;
    }

    #chat-box {
        flex: 1;
        padding: 10px;
        padding-left: 15px;
        border-bottom: 1px solid #333;
        overflow-y: auto; 
    }

    #message-form {
        flex-direction: row; 
    }

    #message-input {
        flex: 1;
        margin-bottom: 0; 
    }

    #send-button, #upload-button {
        flex-shrink: 0; 
        margin-left: 10px; 
    }

    .custom-alert {
        display: none; 
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .alert-content {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        width: 300px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .alert-content span {
        display: block;
        margin-bottom: 15px;
        font-size: 16px;
        color: #333;
    }

    .close-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 14px;
    }

    .close-button:hover {
        background-color: #0056b3;
    }

    #edit-account-button, #reload-button {
        width: 100%; 
    }

    #adminButton {
        width: 100%; 
        margin-bottom: 10px; 
    }
}

#header {
    background-color: #36393e; /* Discord dark mode background color */
    padding: 10px 20px; /* Add horizontal padding for spacing */
    border-radius: 4px; /* Rounded corners */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); /* Subtle shadow */
    color: #ffffff; /* White text color */
    text-align: center; /* Center the text */
    position: absolute; /* Positioning */
    top: 10px; /* Distance from the top */
    left: 50%; /* Centering */
    transform: translateX(-50%); /* Offset the center */
    font-size: 18px; /* Font size */
    width: auto; /* Width based on content */
    min-width: 200px; /* Minimum width for better appearance */
    z-index: 1000; /* Keeps it above other elements */
    border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle border for distinction */
    font-weight: bold; /* Make text bold */
    text-transform: uppercase; /* Make text uppercase */
}

#change-pfp-button {
    position: absolute; /* Use absolute positioning */
    background-color: #42464d; /* Dark button background */
    border: none; /* No border */
    width: 120px; /* Set width */
    height: 50px; /* Set height */
    color: #ffffff; /* Button text color */
    cursor: pointer; /* Cursor style */
    z-index: 1000; /* Stack order */
    transition: background-color 0.3s, transform 0.2s; /* Transition effects */
    font-size: 14px; /* Font size */
    display: flex; /* Use flexbox for alignment */
    align-items: center; /* Vertical alignment */
    justify-content: center; /* Horizontal alignment */
    top: 5px; /* Set y-coordinate */
    right: 550px; /* Set x-coordinate (adjust as needed) */
    text-transform: uppercase; /* Uppercase text */
    font-weight: bold; /* Bold text */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); /* Box shadow */
    border-radius: 0; /* No border-radius for a rectangular shape */
}

#change-pfp-button:hover {
    background-color: #4f545c; /* Lighter on hover */
    transform: scale(1.05); /* Slightly scale on hover */
}

#change-pfp-button:active {
    background-color: #3a3a3a; /* Darker on active */
    transform: scale(0.98); /* Slightly scale down on active */
}


</style>

</head>
<body>
    <button class="open-commands-button" onclick="window.open('/commands', '_blank')">Open Commands Console</button>
    <div id="sidebar">        
        <h3>TRUE THUGS</h3>
        <ul id="user-list"></ul>
        </div>

        <div id="customAlert" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -50%); background-color:rgba(0,0,0,0.8); color:white; padding:20px; border-radius:5px;">
            <span id="alertMessage"></span>
            <button id="alertCloseButton" style="margin-left:10px;">Close</button>
        </div>
        <div id="header" style="background-color: #1c1c1c; padding: 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); color: #ffffff; text-align: center; position: absolute; top: 10px; left: 50%; transform: translateX(-50%);">
            LOGGED IN AS <span id="username-placeholder">{{ username }}</span>
        </div>
        
 <button id="adminButton" class="open-commands-button">ADMIN PANEL</button>

    </div>
    <button id="change-pfp-button" class="open-commands-button" onclick="window.open('/account_settings', '_blank');">Change PFP</button>

    <button id="reload-button" class="open-commands-button">Reload</button>
        <div id="chat-container">

        <div id="chat-box">
            <!-- Messages will be loaded here -->
        </div>
        <div class="typing-indicator" id="typing-indicator"></div>
        <div id="warning-message"></div>
        <form id="message-form" style="position: relative;">
            <textarea id="message-input" placeholder="Type your message..." autofocus></textarea>
            <script>
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        document.getElementById('message-input').focus();
                    }
                });
            </script>
                        <span id="char-count" style="position: absolute; right: 10px; bottom: 10px; color: #aaa; font-size: 0.8em;">0</span>
            <button id="send-button" type="button">>>>></button>
            <button id="upload-button" type="button">Upload File</button>
            <a id="logout-button" href="/logout">Logout</a>
        </form>

        <input id="file-input" type="file" style="display: none;">
        <div class="progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script>
        const socket = io();
        let cachedUserRoles = null;
        const notifySound = new Audio('static/notify.mp3');
        notifySound.preload = 'auto';

        document.addEventListener('DOMContentLoaded', function() {
            const chatBox = document.getElementById('chat-box');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');

document.getElementById('adminButton').addEventListener('click', function() {
    window.open('/admin', '_blank'); 
});

sendButton.addEventListener('click', () => {
    let messageText = messageInput.value.trim();
    messageText = messageText.replace(/\n{2,}/g, '\n'); 

    sendMessage(messageText);
});
            const fileInput = document.getElementById('file-input');
            const progressBar = document.getElementById('progress-bar');
            const userList = document.getElementById('user-list');
            const sidebar = document.getElementById('sidebar');
            const chatContainer = document.getElementById('chat-container');
            const toggleSidebar = document.getElementById('toggle-sidebar');
            const typingIndicator = document.getElementById('typing-indicator');
            const warningMessage = document.getElementById('warning-message');
            const charCount = document.getElementById('char-count');
            const maxChars = 10000;

            messageInput.addEventListener('input', function() {
        if (messageInput.value.length > maxChars) {
            messageInput.value = messageInput.value.substring(0, maxChars); 
        }
        const count = messageInput.value.length;
        charCount.textContent = count; 
    });

        const reloadButton = document.getElementById('reload-button');
        reloadButton.addEventListener('click', function() {
            location.reload(); 
        });            

        socket.on('ban_packet', function(data) {
    alert('You have been banned from the chat: ' + data.username);

    fetch('/logout', {
        method: 'POST', 
        credentials: 'include' 
    })
    .then(response => {
        if (response.ok) {
            window.location.reload(); 
        } else {
            console.error('Failed to log out.');
        }
    })
    .catch(error => {
        console.error('Error during logout:', error);
    });
});

            initializeUserList();
            initializeChat();

            function initializeUserList() {
    // Preload the audio file
    const hoverSound = new Audio('static/enter-cmd.ogg');

    fetch('/get_user_accounts')
        .then(response => response.json())
        .then(users => {
            users.forEach(user => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.textContent = user;
                button.classList.add('userbutton');

                button.addEventListener('click', () => {
                    window.open(`/userinfo-${user}`, '_blank');
                });

                // Add hover event listener to play sound
                button.addEventListener('mouseenter', () => {
                    hoverSound.currentTime = 0; // Reset the audio to the beginning
                    hoverSound.play(); // Play the sound
                });

                li.appendChild(button);
                userList.appendChild(li);
            });
        })
        .catch(error => {
            console.error('Error fetching user accounts:', error);
        }); // Add error handling for the fetch call
}


            function initializeChat() {
    fetch('/get_messages')
        .then(response => response.json())
        .then(messages => {
            messages.forEach(msg => {
                chatBox.appendChild(createMessageElement(msg));
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        socket.on('message', function(msg) {
    const messageId = msg.timestamp;

    // Fetch all messages from the server every time a new message is received
    fetchMessages();

    // Check if the message is already displayed in the chatbox
    if (!Array.from(chatBox.children).some(child => child.dataset.timestamp === messageId)) {
        chatBox.appendChild(createMessageElement(msg));
        chatBox.scrollTop = chatBox.scrollHeight;

        const videos = document.querySelectorAll('video');
        let isPlaying = false;

        videos.forEach(video => {
            if (!video.paused) {
                isPlaying = true;
            }
        });

        if (!isPlaying) {
            notifySound.play().catch(error => {
                console.error('Error playing sound:', error);
            });
        }
    }



        setTimeout(() => {
            if (msg.type === 'file') {
                window.scrollTo(0, document.body.scrollHeight);
            } else {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }, 1000);
    });

    


    let previousMessages = [];

function fetchMessages() {
    fetch('/data/chatlogs.json')
        .then(response => {
            
            if (!response.ok) {
                chatBox.innerHTML = ''; 
                console.error('Chatlogs not found. Chatbox emptied.');
                return;  
            }
            return response.json();
        })
        .then(data => {
            const messages = data.messages || [];

           
            if (JSON.stringify(messages) === JSON.stringify(previousMessages)) {
                return; 
            }

            Array.from(chatBox.children).forEach(child => {
                const messageId = child.dataset.timestamp;
                if (!messages.some(msg => msg.timestamp === messageId)) {
                    chatBox.removeChild(child);
                }
            });

            messages.forEach(msg => {
                const messageId = msg.timestamp;
                const existingElement = Array.from(chatBox.children).find(child => child.dataset.timestamp === messageId);

                if (!existingElement) {
                    chatBox.appendChild(createMessageElement(msg));
                } else if (existingElement.innerHTML !== createMessageElement(msg).innerHTML) {
                    existingElement.innerHTML = createMessageElement(msg).innerHTML;
                }
            });

            previousMessages = messages;

            chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(error => {
            chatBox.innerHTML = '';  
            console.error('Error loading messages:', error);
        });
}

setInterval(fetchMessages, 5000);

                let typingUsers = new Set();
                let typingTimeouts = new Map();

                socket.on('typing', function(data) {
                    typingUsers.add(data.username);
                    updateTypingIndicator(data.username);

                    if (typingTimeouts.has(data.username)) {
                        clearTimeout(typingTimeouts.get(data.username));
                    }

                    typingTimeouts.set(data.username, setTimeout(() => {
                        typingUsers.delete(data.username);
                        updateTypingIndicator();
                    }, 2000));
                });

                function updateTypingIndicator(username) {
                    if (username) {
                        typingIndicator.textContent = `${Array.from(typingUsers).join(', ')} ${typingUsers.size > 1 ? 'are' : 'is'} typing...`;
                    } else {
                        typingIndicator.textContent = '';
                    }
                }

                socket.on('error', function(data) {
                    warningMessage.textContent = data.error;
                    warningMessage.style.display = 'block';
                    setTimeout(() => {
                        warningMessage.style.display = 'none';
                    }, 3000);
                });

                document.getElementById('send-button').addEventListener('click', sendMessage);
                let typingInterval;

                document.getElementById('message-input').addEventListener('focus', function() {
                    socket.emit('typing');
                    typingInterval = setInterval(() => {
                        socket.emit('typing');
                    }, 2000);
                });

                document.getElementById('message-input').addEventListener('blur', function() {
                    clearInterval(typingInterval);
                });

                document.getElementById('message-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); 
        sendMessage(); 
    } else if (e.key === 'Enter' && e.shiftKey) {

        const start = this.selectionStart;
        const end = this.selectionEnd;
        this.value = this.value.substring(0, start) + '\n' + this.value.substring(end);
        this.selectionStart = this.selectionEnd = start + 1;
        e.preventDefault(); 
    }
});




                document.getElementById('upload-button').addEventListener('click', function() {
                    fileInput.click();
                });

                fileInput.addEventListener('change', function() {
                    const file = fileInput.files[0];
                    if (file) {
                        uploadFile(file);
                    }
                });

                toggleSidebar.addEventListener('click', function() {
                    sidebar.classList.toggle('expanded');
                    chatContainer.classList.toggle('expanded');
                });
            }

            function sendMessage() {
    const message = messageInput.value.trim();
    if (message) {
        const formattedMessage = formatMessage(message);
        socket.send(formattedMessage);
        messageInput.value = '';

        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

function embedYouTubeVideo(url) {
    const youtubePattern = /https?:\/\/(www\.)?(youtube\.com|youtu\.be)\/(watch\?v=|embed\/|v\/)?([^\s&]+)/;

    if (url.includes('/shorts/')) {
        return null; 
    }

    const match = url.match(youtubePattern);

    if (match) {
        const videoId = match[4]; 
        return `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    }
    return null; 
}

function embedYouTubeShorts(url) {
    const youtubeShortsPattern = /https?:\/\/(www\.)?youtube\.com\/shorts\/([a-zA-Z0-9_-]+)/;
    const match = url.match(youtubeShortsPattern);

    if (match) {
        const shortsId = match[2]; 
        return `<iframe width="350" height="560" src="https://www.youtube.com/embed/${shortsId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    }
    return null; 
}

function embedDiscordInvite(url) {
    const discordInvitePattern = /^(https?:\/\/)?(www\.)?(discord\.gg|discord\.com\/invite)\/[a-zA-Z0-9]+$/;
    const match = url.match(discordInvitePattern);

    if (match) {
        const formattedUrl = url.startsWith('http') ? url : `https://${url}`;
        return `
            <a href="${formattedUrl}" target="_blank" rel="noopener noreferrer">
                <img src="static/discordinvite.png" style="width: 200px; height: 400px; border-radius: 8px;"/>
            </a>`;
    }
    return null;
}


function formatLinks(message) {
    const urlPattern = /(?<!\S)(https?:\/\/[^\s]+)/g;

    return message.replace(urlPattern, function(url) {
        const embedVideo = embedYouTubeVideo(url);
        const embedShorts = embedYouTubeShorts(url);
        const embedInvite = embedDiscordInvite(url);

        return embedVideo || embedShorts || embedInvite || `<a href="${url}" class="link" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
}

function formatMessage(message) {
    message = message

    message = formatLinks(message);
    return message;
}

function showCustomAlert(message) {
    const alertBox = document.getElementById('customAlert');
    const alertMessage = document.getElementById('alertMessage');
    const alertCloseButton = document.getElementById('alertCloseButton');

    alertMessage.innerText = message;
    alertBox.style.display = 'block';

    alertCloseButton.onclick = function() {
        alertBox.style.display = 'none';
    };
}

function uploadFile(file) {
    const maxFileSize = 10 * 1024 * 1024 * 1024; 

    if (file.size > maxFileSize) {
        showCustomAlert('File size exceeds the maximum limit of 10 GB.');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);
    progressBar.style.display = 'block'; 
    progressBar.style.width = '0%'; 

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/files/upload', true);

    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressBar.style.width = percentComplete + '%';
        }
    };

    xhr.onload = function() {
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.file_url) {
                const message = getMediaMessage(file, response.file_url);
                socket.send(message);
                progressBar.style.width = '0%'; 
                progressBar.style.display = 'none'; 
            }
        } else {
            showCustomAlert('File upload failed. Please try again.');
        }
    };

    xhr.onerror = function() {
        showCustomAlert('An error occurred while uploading the file.');
    };

    xhr.send(formData);
}

function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();

    const isToday = date.toDateString() === now.toDateString();
    const isYesterday = new Date(now.setDate(now.getDate() - 1)).toDateString() === date.toDateString();

    const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
    const timeString = date.toLocaleTimeString([], timeOptions);
    
    const year = date.getFullYear();
    const currentYear = now.getFullYear();

    if (isToday) {
        return `Today at ${timeString}`;
    } else if (isYesterday) {
        return `Yesterday at ${timeString}`;
    } else {
        const dateOptions = { month: 'short', day: 'numeric' };
        const dateString = date.toLocaleDateString([], dateOptions);

        if (year !== currentYear) {
            return `${dateString}, ${year} at ${timeString}`;
        } else {
            return `${dateString} at ${timeString}`;
        }
    }
}


const specificTimestamp = new Date('2024-10-06T14:30:00').getTime(); // Adjust the date and time as needed
console.log(formatTimestamp(specificTimestamp));


function coloredText(message) {
    if (message.startsWith('RR') && message.endsWith('RR')) {
        const innerMessage = message.slice(2, -2);
        return `<span style="color: red; font-weight: bold;">${innerMessage}</span>`;
    }
    return message; 
}

async function fetchUserRoles() {
    if (cachedUserRoles) {
        return cachedUserRoles; // Return cached roles if available
    }

    try {
        const response = await fetch('https://thugchat.ddns.net/roles/data/userroles.json');
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();
        cachedUserRoles = data; // Cache the roles for future use
        return data;
    } catch (error) {
        console.error('Failed to fetch user roles:', error);
        return {}; // Return an empty object if there's an error
    }
}

async function colorNames(username) {
    const userRoles = await fetchUserRoles(); // Fetch user roles asynchronously
    const roleColorMapping = {
        'owner': 'blue',    
        'admin': 'red',    
        'moderator': 'green', 
        'W THUG': 'cyan'    
    };

    // Check if userRoles has the username and if it has additionalRoles
    if (userRoles[username] && Array.isArray(userRoles[username].additionalRoles)) {
        const roles = userRoles[username].additionalRoles;


        if (roles.includes('owner')) {
            return roleColorMapping['owner']; 
        }
        if (roles.includes('admin')) {
            return roleColorMapping['admin']; // Return red if the user is an admin
        }
        if (roles.includes('moderator')) {
            return roleColorMapping['moderator']; // Return green if the user is a moderator
        }
        if (roles.includes('W THUG')) {
            return roleColorMapping['W THUG']; // Return cyan if the user is a W THUG
        }
    }

    return 'white'; // Default color if username not found or no relevant role
}






    
function createMessageElement(msg) {
    const div = document.createElement('div');
    div.className = 'message';

    const formattedTime = formatTimestamp(msg.timestamp);
    const profilePictureUrl = `/static/pfps/${msg.username.toLowerCase()}.png`; 
    const defaultProfilePictureUrl = '/static/boring/default.png'; 

    const img = new Image();
    img.src = profilePictureUrl;

    img.onerror = function() {
        img.src = defaultProfilePictureUrl; 
    };

    if (msg.file_url) {
        div.classList.add('media-message'); 
        const mediaElement = document.createElement('img'); 
        mediaElement.src = msg.file_url; 
        mediaElement.alt = `${msg.username}'s media`;
        mediaElement.style.maxWidth = '300px'; 
        mediaElement.style.borderRadius = '8px'; 
        div.appendChild(mediaElement);
    } else {
        let formattedMessage = formatLinks(msg.message);
        formattedMessage = coloredText(formattedMessage); 
        const wrappedMessage = wrapLongMessage(formattedMessage, 85);

        // Use .then() to handle the promise from colorNames
        colorNames(msg.username).then(usernameColor => {
            const usernameStyle = `color: ${usernameColor}; font-weight: bold;`;

            div.innerHTML = `
                <div class="message-content" style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center;">
                        <img src="${profilePictureUrl}" alt="${msg.username}'s profile picture" class="profile-picture" style="margin-right: 8px;" onerror="this.src='${defaultProfilePictureUrl}';">
                        <div>
                            <span class="username" style="${usernameStyle}">${msg.username}:</span>
                            ${wrappedMessage}
                        </div>
                    </div>
                    <span class="timestamp">${formattedTime}</span>
                </div>
            `;
        });
    }

    return div;
}





            function wrapLongMessage(text, maxLength) {
                if (text.length <= maxLength) {
                    return text;
                }

                let result = '';
                while (text.length > maxLength) {
                    result += text.slice(0, maxLength) + '<br>';
                    text = text.slice(maxLength);
                }
                result += text;

                return result;
            }

            function getMediaMessage(file, fileUrl) {
    const fileName = file.name;
    const fileExtension = fileName.split('.').pop().toLowerCase(); 
    let mediaMessage = '';

    if (file.type.startsWith('image/')) {
        if (fileExtension === 'gif') {
            mediaMessage = `<img src="${fileUrl}" alt="Uploaded GIF">`;
        } else {
            mediaMessage = `<img src="${fileUrl}" alt="Uploaded image">`;
        }
    } else if (file.type.startsWith('video/') || fileExtension === 'mov') {
        mediaMessage = `<video src="${fileUrl}" controls>Your browser does not support video playback.</video>`;
    } else if (file.type.startsWith('audio/')) {
        mediaMessage = `<audio src="${fileUrl}" controls>Your browser does not support audio playback.</audio>`;
    } else {
        mediaMessage = `<a href="${fileUrl}" download class="download-button">Download ${fileName}</a>`;
    }

    return mediaMessage;
}

        });
    </script>
</body>
</html>
